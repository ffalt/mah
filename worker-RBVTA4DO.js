function y(){return Math.floor(Math.random()*100)}function c(p){if(!p)return!1;let e=0,t=p.above[e];for(;t!==void 0;){if(!t.isPlayed)return!1;e++,t=p.above[e]}e=0;let r=p.left[e];for(;r!==void 0;){if(!r.isPlayed){e=0;let i=p.right[e];for(;i!==void 0;){if(!i.isPlayed)return!1;e++,i=p.right[e]}return!0}e++,r=p.left[e]}return!0}var g=class{constructor(e,t,r,i,n,s,a,l){this.tileList=e;this.lo=t;this.qts=r;this.maxHeight=i;this.maxWidth=n;this.maxDepth=s;this.maxGroups=a;this.nTilesCount=l;this.tileGroups=[]}initSolve(){return this.initSolve_clearTileNeighbors(),this.initSolve_computeHorizontalNeighbors(),this.initSolve_computeVerticalNeighbors(),this.initSolve_initializeGroups(),this.initSolve_setupSearchSystem(),{tileGroups:this.tileGroups,qtsIndex:this.qtsIndex,nGroups:this.nGroups}}initSolve_clearTileNeighbors(){for(let e of this.tileList){for(let t of["left","right","above","below"]){let r=t==="above"||t==="below"?5:3;for(let i=0;i<r;i++)e[t][i]=void 0}e.isPlayed=!1}}initSolve_forEachAdjacentPosition(e,t,r){for(let i=Math.max(e-1,0);i<Math.min(e+2,this.maxHeight);i++)for(let n=Math.max(t-1,0);n<Math.min(t+2,this.maxWidth);n++)r(i,n)}initSolve_linkHorizontalNeighbors(e,t,r){let i=this.lo[e][t][r],n=this.lo[e][t-2][r];if(i){let s=0;for(let a=Math.max(e-1,0);a<Math.min(e+2,this.maxHeight);a++)this.lo[a][t-2][r]&&(i.left[s++]=this.lo[a][t-2][r])}if(n){let s=0;for(let a=Math.max(e-1,0);a<Math.min(e+2,this.maxHeight);a++)this.lo[a][t][r]&&(n.right[s++]=this.lo[a][t][r])}}initSolve_computeHorizontalNeighbors(){for(let e=0;e<this.maxHeight;e++)for(let t=2;t<this.maxWidth;t++)for(let r=0;r<this.maxDepth;r++)this.initSolve_linkHorizontalNeighbors(e,t,r)}initSolve_linkVerticalNeighbors(e,t,r){let i=this.lo[e][t][r-1],n=this.lo[e][t][r];if(i){let s=0;this.initSolve_forEachAdjacentPosition(e,t,(a,l)=>{this.lo[a][l][r]&&(i.above[s++]=this.lo[a][l][r])})}if(n){let s=0;this.initSolve_forEachAdjacentPosition(e,t,(a,l)=>{this.lo[a][l][r-1]&&(n.below[s++]=this.lo[a][l][r-1])})}}initSolve_computeVerticalNeighbors(){for(let e=0;e<this.maxHeight;e++)for(let t=0;t<this.maxWidth;t++)for(let r=1;r<this.maxDepth;r++)this.initSolve_linkVerticalNeighbors(e,t,r)}initSolve_initializeGroups(){this.tileGroups=[];for(let e=0;e<this.maxGroups;e++)this.tileGroups.push({pairing:-1,bestPairing:-1,nMembers:0,member:[void 0,void 0,void 0,void 0],isPlayed:!1,rotation:0});for(let e=0;e<this.nTilesCount;e++){let t=this.tileList[e].value;this.tileGroups[t].member[this.tileGroups[t].nMembers]=this.tileList[e],this.tileGroups[t].nMembers++}}initSolve_setupSearchSystem(){let e=0,t=0;for(let r=0;r<this.maxGroups;r++){let i=this.tileGroups[r];i.nMembers===2&&(this.qts[e]=i,this.qts[e].pairing=4,e++),i.nMembers!==0&&(t=r)}for(let r=0;r<=t;r++){let i=this.tileGroups[r];i.nMembers===0&&(this.qts[e]=i,this.qts[e].pairing=-1,e++)}this.qtsIndex=e;for(let r=0;r<=t;r++){let i=this.tileGroups[r];if(i.nMembers===4){this.qts[e]=i,this.qts[e].pairing=0;let n=this.qtsIndex+y()%(e+1-this.qtsIndex),s=this.qts[e];this.qts[e]=this.qts[n],this.qts[n]=s,e++}}this.nGroups=e}};var S=class{constructor(e,t,r,i,n,s,a){this.qt=t;this.lo=r;this.nGroups=i;this.maxHeight=n;this.maxWidth=s;this.maxDepth=a;this.result=[];this.nTiles1=e,this.nTiles2=e}write(){do{this.nTiles1=this.nTiles2;for(let e=0;e<this.nGroups;e++)this.writeGroup(e)}while(this.nTiles2!==this.nTiles1);return this.result}writePair(e,t,r){let i=this.qt[e].member[t],n=this.qt[e].member[r];for(let s=0;s<this.maxHeight;s++)for(let a=0;a<this.maxWidth;a++)for(let l=0;l<this.maxDepth;l++)(this.lo[s][a][l]===i||this.lo[s][a][l]===n)&&this.result.push([l,a,s])}writePairing(e,t,r,i){let n=t.member[r],s=t.member[i],a=n&&s,l=a&&!n.isPlayed,d=a&&c(n)&&c(s);return a&&l&&d?(this.writePair(e,r,i),n.isPlayed=!0,s.isPlayed=!0,this.nTiles2-=2,!0):!1}writeGroup(e){let t=this.qt[e];switch(t.bestPairing){case 1:{if(this.writePairing(e,t,0,1)){let r=t.member[2];t.isPlayed=r.isPlayed}this.writePairing(e,t,2,3);break}case 2:{this.writePairing(e,t,0,2),this.writePairing(e,t,1,3);break}case 3:{this.writePairing(e,t,0,3),this.writePairing(e,t,1,2);break}case 4:{this.writePairing(e,t,0,1);break}default:break}}};var T=class{constructor(e,t,r,i){this.nTilesCount=e;this.nGroups=t;this.tileList=r;this.tileGroups=i}play(e,t){return e.isPlayed=!0,t.isPlayed=!0,2}checkFree(e){return!e.isPlayed&&c(e)?(e.isPlayed=!0,1):0}handlePairedGroup(e,t,r,i){let n=0;return!e.isPlayed&&c(e)&&c(t)&&(n=this.play(e,t),i.isPlayed=r.isPlayed),n}resetState(){for(let e=0;e<this.nTilesCount;e++)this.tileList[e].isPlayed=!1;for(let e=0;e<this.nGroups;e++)this.tileGroups[e].isPlayed=!1}tryPlayWith(e,t){if(!e.isPlayed&&c(e)){for(let r of t)if(!r.isPlayed&&c(r))return[!0,this.play(e,r)]}return[!1,0]}handleFreeGroup(e,t){let r=0,i=0,[n,s,a,l]=t;if(n.isPlayed||s.isPlayed||a.isPlayed){for(let m of t)r+=this.checkFree(m);return t.every(m=>m.isPlayed)&&(e.isPlayed=!0,i+=2),[r,i]}let[d,f]=this.tryPlayWith(n,[s,a,l]);if(i+=f,d)return[r,i];if([d,f]=this.tryPlayWith(s,[a,l]),i+=f,d)return[r,i];let[o,u]=this.tryPlayWith(a,[l]);return i+=u,[r,i]}processGroup(e){if(e.isPlayed)return[0,0];let t=e.member,[r,i,n,s]=t,a=0,l=0;switch(e.pairing){case 0:{let[d,f]=this.handleFreeGroup(e,t);a+=d,l+=f;break}case 1:{l+=this.handlePairedGroup(r,i,n,e),l+=this.handlePairedGroup(n,s,r,e);break}case 2:{l+=this.handlePairedGroup(r,n,i,e),l+=this.handlePairedGroup(i,s,r,e);break}case 3:{l+=this.handlePairedGroup(r,s,i,e),l+=this.handlePairedGroup(i,n,r,e);break}case 4:{c(r)&&c(i)&&(l+=this.play(r,i),e.isPlayed=!0);break}case 5:{t.every(d=>c(d))&&(l+=this.play(r,i),l+=this.play(n,s),e.isPlayed=!0);break}}return[a,l]}prune(){let e=this.nTilesCount,t;do{t=e;for(let r=0;r<this.nGroups;r++){let[i,n]=this.processGroup(this.tileGroups[r]);t+=i,e-=n}}while(e!==t);return this.resetState(),e}};var G=class{constructor(e,t,r,i,n,s){this.nTilesCount=e;this.nGroups=t;this.tileList=r;this.tileGroups=i;this.remainMin=n;this.remainMax=s;this.nrPlays=0}randomSolve(e){let t=[],r=[0,0,1,3,6],i=[[0,1,2,3],[1,0,3,2],[2,3,0,1],[3,2,1,0]],n=()=>{for(let o=0;o<this.nGroups;o++){t[o]=0;let u=this.tileGroups[o];for(let m=0;m<u.nMembers;m++)c(u.member[m])&&t[o]++;u.pairing=-1,u.isPlayed=u.nMembers===2}},s=()=>{let o=0;for(let h=0;h<this.nGroups;h++){if((this.tileGroups[h].isPlayed?1:0)+r[t[h]]>=5)return{groupIndex:h,matchIndex:0};o+=r[t[h]]}if(o===0)return null;let u=y()%o,m=0;for(;u>=0&&(u-=r[t[m]],!(u<0));)m++;return{groupIndex:m,matchIndex:u+r[t[m]]}},a=(o,u)=>{let m=0,h=o.nMembers-1,_=(b,w)=>{let v=b;for(;;){let E=o.member[v];if(!E.isPlayed&&c(E))break;v+=w}return v};return u<=1&&(m=_(m,1),u===0&&(h=_(m+1,1))),u>=1&&(h=_(h,-1),u===2&&(m=_(h-1,-1))),[m,h]},l=(o,u,m)=>{let[h,_]=u,b=m;return b=this.playTile(o.member[h],t,b),b=this.playTile(o.member[_],t,b),o.isPlayed=!0,o.pairing=i[h][_],t[this.tileGroups.indexOf(o)]-=2,b},d=()=>{for(let o=0;o<this.nTilesCount;o++)this.tileList[o].isPlayed=!1;for(let o=0;o<this.nGroups;o++)this.tileGroups[o].isPlayed=!1,this.tileGroups[o].nMembers===2&&(this.tileGroups[o].pairing=4)},f=o=>{if(o>this.remainMax)return!1;for(let u=0;u<this.nGroups;u++)this.tileGroups[u].bestPairing=this.tileGroups[u].pairing;if(this.remainMax=o-2,this.remainMax<this.remainMin){for(let u=0;u<this.nGroups;u++)this.tileGroups[u].nMembers===4&&(this.tileGroups[u].pairing=0);return!0}return!1};for(let o=0;o<e;o++){let u=this.nTilesCount;for(n();;){let m=s();if(!m)break;let h=this.tileGroups[m.groupIndex],_=a(h,m.matchIndex);u=l(h,_,u)}if(d(),this.nrPlays++,f(u))return{success:!0,nrPlays:this.nrPlays,remainMax:this.remainMax}}for(let o=0;o<this.nGroups;o++)this.tileGroups[o].nMembers===4&&(this.tileGroups[o].pairing=0);return{success:!1,nrPlays:this.nrPlays,remainMax:this.remainMax}}playTile(e,t,r){let i=(s,a)=>{for(let l=0;s[l]!==void 0;l++){let d=s[l];d&&!d.isPlayed&&(t[d.value]+=c(d)?a:0)}};i(e.left,-1),i(e.right,-1),e.isPlayed=!0;let n=r-1;return i(e.left,1),i(e.right,1),i(e.below,1),n}};var A=class{constructor(){this.tileList=[];this.tileGroups=[];this.lo=[];this.qts=[];this.maxGroups=80;this.maxHeight=40;this.maxWidth=100;this.maxDepth=10}solveLayout(e){for(let t=0;t<this.maxHeight;t++){this.lo[t]=[];for(let r=0;r<this.maxWidth;r++){this.lo[t][r]=[];for(let i=0;i<this.maxDepth;i++)this.lo[t][r][i]=void 0}}for(let t of e){let r={left:[void 0,void 0,void 0],right:[void 0,void 0,void 0],above:[void 0,void 0,void 0,void 0,void 0],below:[void 0,void 0,void 0,void 0,void 0],value:t.groupNr,isPlayed:!1};this.lo[t.y][t.x][t.z]=r,this.tileList.push(r)}return this.nTilesCount=e.length,this.solve(0,0)}writeGame(){return this.unrotateGroups(),new S(this.nTilesCount,this.tileGroups,this.lo,this.nGroups,this.maxHeight,this.maxWidth,this.maxDepth).write()}unrotateGroups(){for(let e=0;e<this.nGroups;e++){switch(this.tileGroups[e].rotation){case 1:{let t=this.tileGroups[e].member[1];this.tileGroups[e].member[1]=this.tileGroups[e].member[2],this.tileGroups[e].member[2]=this.tileGroups[e].member[3],this.tileGroups[e].member[3]=t;break}case 2:{let t=this.tileGroups[e].member[3];this.tileGroups[e].member[3]=this.tileGroups[e].member[2],this.tileGroups[e].member[2]=this.tileGroups[e].member[1],this.tileGroups[e].member[1]=t;break}default:break}this.tileGroups[e].rotation=0}}sureSolve_checkInitialPrune(){return this.prune()>this.remainMax}sureSolve_findPrunePoint(e){for(let t=e;t<this.nGroups;t++)if(this.qts[t].pairing=1,this.prune()>this.remainMax)return t;return this.nGroups}sureSolve_handleSolutionFound(e){for(let t=0;t<this.nGroups;t++)this.tileGroups[t].bestPairing=this.tileGroups[t].pairing;for(let t=this.qtsIndex;t<this.nGroups;t++)this.qts[t].bestPairing+=3-this.qts[t].rotation,this.qts[t].bestPairing>3&&(this.qts[t].bestPairing-=3);if(this.remainMax=this.prune()-2,this.remainMax<this.remainMin){for(let t=this.qtsIndex;t<this.nGroups;t++)this.qts[t].pairing=0;return!0}for(let t=e;t<this.nGroups;t++)this.qts[t].pairing=0;return this.sureSolve(e)}sureSolve_rotateTiles(e,t){let r=this.qts[e];if(t){let i=r.member[3];r.member[3]=r.member[2],r.member[2]=r.member[1],r.member[1]=i,r.rotation=(r.rotation+1)%3}else{let i=r.member[1];r.member[1]=r.member[2],r.member[2]=r.member[3],r.member[3]=i,r.rotation=(r.rotation+2)%3}}sureSolve_identifyRequiredNodes(e,t){let r=[this.qts[e]],i=1,n=e;for(let s=e-1;s>=t;s--)this.qts[s].pairing=0,this.prune()<=this.remainMax?(this.qts[s].pairing=1,r[i++]=this.qts[s]):(this.sureSolve_rotateTiles(s,y()%2===0),this.qts[n]=this.qts[s],n--);for(let s=n;s>=t;s--)this.qts[s]=r[--i];return n}sureSolve_tryAdvancedPairings(e,t){for(let r=e;r>=t;r--){if(this.qts[r].pairing=2,this.sureSolve(r+1)||(this.qts[r].pairing=3,this.sureSolve(r+1)))return!0;this.qts[r].pairing=0}return!1}sureSolve(e){if(this.sureSolve_checkInitialPrune())return!1;let t=this.sureSolve_findPrunePoint(e);if(t===this.nGroups)return this.sureSolve_handleSolutionFound(e);let r=this.sureSolve_identifyRequiredNodes(t,e);return this.sureSolve_tryAdvancedPairings(r,e)}init(){let e=new g(this.tileList,this.lo,this.qts,this.maxHeight,this.maxWidth,this.maxDepth,this.maxGroups,this.nTilesCount).initSolve();this.tileGroups=e.tileGroups,this.qtsIndex=e.qtsIndex,this.nGroups=e.nGroups}prune(){return this.nPlays++,new T(this.nTilesCount,this.nGroups,this.tileList,this.tileGroups).prune()}randomSolve(e){let t=new G(this.nTilesCount,this.nGroups,this.tileList,this.tileGroups,this.remainMin,this.remainMax).randomSolve(e);return this.remainMax=t.remainMax,this.nrPlays+=t.nrPlays,t.success}solve(e,t){if(this.init(),this.nrPlays=0,this.nPlays=0,this.remainMax=Math.max(e,t),this.remainMin=Math.min(e,t),this.prune()>this.remainMax)return this.remainMax+2;let r=Math.floor(1.2**(this.nGroups-this.qtsIndex));return this.randomSolve(r)?this.remainMax+2:(this.sureSolve(this.qtsIndex),this.unrotateGroups(),this.remainMax+2)}};var x=[];for(let p=1;p<19;p++)x.push([`t_g${p}`,`t_g${p}`,`t_g${p}`,`t_g${p}`]);for(let p=1;p<10;p++)x.push([`t_e${p}`,`t_e${p}`,`t_e${p}`,`t_e${p}`]);function N(p,e){let t=new A,r=t.solveLayout(p);e({result:r,order:t.writeGame()})}addEventListener("message",({data:p})=>{p&&N(p.stones,e=>{postMessage({result:e})})});
