import{g as R}from"./chunk-MWUYH7ZA.js";import{B as $,j as O,l as E}from"./chunk-XMPER2Q5.js";import{L as j,Pa as H,Ra as A,b as g,ca as D,g as x,h as T,j as v,m as N,o as L,ob as _,q as W,qa as z,qb as F,u as I}from"./chunk-UWITPWPI.js";function G(){return Math.floor(Math.random()*100)}function d(o){if(!o)return!1;let t=0,e=o.above[t];for(;e!==void 0;){if(!e.isPlayed)return!1;t++,e=o.above[t]}t=0;let i=o.left[t];for(;i!==void 0;){if(!i.isPlayed){t=0;let s=o.right[t];for(;s!==void 0;){if(!s.isPlayed)return!1;t++,s=o.right[t]}return!0}t++,i=o.left[t]}return!0}var M=class{constructor(t,e,i,s,r,n,a,l){this.tileList=t,this.lo=e,this.qts=i,this.maxHeight=s,this.maxWidth=r,this.maxDepth=n,this.maxGroups=a,this.nTilesCount=l,this.tileGroups=[]}initSolve(){return this.initSolve_clearTileNeighbors(),this.initSolve_computeHorizontalNeighbors(),this.initSolve_computeVerticalNeighbors(),this.initSolve_initializeGroups(),this.initSolve_setupSearchSystem(),{tileGroups:this.tileGroups,qtsIndex:this.qtsIndex,nGroups:this.nGroups}}initSolve_clearTileNeighbors(){for(let t of this.tileList){for(let e of["left","right","above","below"]){let i=e==="above"||e==="below"?5:3;for(let s=0;s<i;s++)t[e][s]=void 0}t.isPlayed=!1}}initSolve_forEachAdjacentPosition(t,e,i){for(let s=Math.max(t-1,0);s<Math.min(t+2,this.maxHeight);s++)for(let r=Math.max(e-1,0);r<Math.min(e+2,this.maxWidth);r++)i(s,r)}initSolve_linkHorizontalNeighbors(t,e,i){let s=this.lo[t][e][i],r=this.lo[t][e-2][i];if(s){let n=0;for(let a=Math.max(t-1,0);a<Math.min(t+2,this.maxHeight);a++)this.lo[a][e-2][i]&&(s.left[n++]=this.lo[a][e-2][i])}if(r){let n=0;for(let a=Math.max(t-1,0);a<Math.min(t+2,this.maxHeight);a++)this.lo[a][e][i]&&(r.right[n++]=this.lo[a][e][i])}}initSolve_computeHorizontalNeighbors(){for(let t=0;t<this.maxHeight;t++)for(let e=2;e<this.maxWidth;e++)for(let i=0;i<this.maxDepth;i++)this.initSolve_linkHorizontalNeighbors(t,e,i)}initSolve_linkVerticalNeighbors(t,e,i){let s=this.lo[t][e][i-1],r=this.lo[t][e][i];if(s){let n=0;this.initSolve_forEachAdjacentPosition(t,e,(a,l)=>{this.lo[a][l][i]&&(s.above[n++]=this.lo[a][l][i])})}if(r){let n=0;this.initSolve_forEachAdjacentPosition(t,e,(a,l)=>{this.lo[a][l][i-1]&&(r.below[n++]=this.lo[a][l][i-1])})}}initSolve_computeVerticalNeighbors(){for(let t=0;t<this.maxHeight;t++)for(let e=0;e<this.maxWidth;e++)for(let i=1;i<this.maxDepth;i++)this.initSolve_linkVerticalNeighbors(t,e,i)}initSolve_initializeGroups(){this.tileGroups=[];for(let t=0;t<this.maxGroups;t++)this.tileGroups.push({pairing:-1,bestPairing:-1,nMembers:0,member:[void 0,void 0,void 0,void 0],isPlayed:!1,rotation:0});for(let t=0;t<this.nTilesCount;t++){let e=this.tileList[t].value;this.tileGroups[e].member[this.tileGroups[e].nMembers]=this.tileList[t],this.tileGroups[e].nMembers++}}initSolve_setupSearchSystem(){let t=0,e=0;for(let i=0;i<this.maxGroups;i++){let s=this.tileGroups[i];s.nMembers===2&&(this.qts[t]=s,this.qts[t].pairing=4,t++),s.nMembers!==0&&(e=i)}for(let i=0;i<=e;i++){let s=this.tileGroups[i];s.nMembers===0&&(this.qts[t]=s,this.qts[t].pairing=-1,t++)}this.qtsIndex=t;for(let i=0;i<=e;i++){let s=this.tileGroups[i];if(s.nMembers===4){this.qts[t]=s,this.qts[t].pairing=0;let r=this.qtsIndex+G()%(t+1-this.qtsIndex),n=this.qts[t];this.qts[t]=this.qts[r],this.qts[r]=n,t++}}this.nGroups=t}};var w=class{constructor(t,e,i,s,r,n,a){this.qt=e,this.lo=i,this.nGroups=s,this.maxHeight=r,this.maxWidth=n,this.maxDepth=a,this.result=[],this.nTiles1=t,this.nTiles2=t}write(){do{this.nTiles1=this.nTiles2;for(let t=0;t<this.nGroups;t++)this.writeGroup(t)}while(this.nTiles2!==this.nTiles1);return this.result}writePair(t,e,i){let s=this.qt[t].member[e],r=this.qt[t].member[i];for(let n=0;n<this.maxHeight;n++)for(let a=0;a<this.maxWidth;a++)for(let l=0;l<this.maxDepth;l++)(this.lo[n][a][l]===s||this.lo[n][a][l]===r)&&this.result.push([l,a,n])}writePairing(t,e,i,s){let r=e.member[i],n=e.member[s],a=r&&n,l=a&&!r.isPlayed,u=a&&d(r)&&d(n);return a&&l&&u?(this.writePair(t,i,s),r.isPlayed=!0,n.isPlayed=!0,this.nTiles2-=2,!0):!1}writeGroup(t){let e=this.qt[t];switch(e.bestPairing){case 1:{if(this.writePairing(t,e,0,1)){let i=e.member[2];e.isPlayed=i.isPlayed}this.writePairing(t,e,2,3);break}case 2:{this.writePairing(t,e,0,2),this.writePairing(t,e,1,3);break}case 3:{this.writePairing(t,e,0,3),this.writePairing(t,e,1,2);break}case 4:{this.writePairing(t,e,0,1);break}default:break}}};var S=class{constructor(t,e,i,s){this.nTilesCount=t,this.nGroups=e,this.tileList=i,this.tileGroups=s}play(t,e){return t.isPlayed=!0,e.isPlayed=!0,2}checkFree(t){return!t.isPlayed&&d(t)?(t.isPlayed=!0,1):0}handlePairedGroup(t,e,i,s){let r=0;return!t.isPlayed&&d(t)&&d(e)&&(r=this.play(t,e),s.isPlayed=i.isPlayed),r}resetState(){for(let t=0;t<this.nTilesCount;t++)this.tileList[t].isPlayed=!1;for(let t=0;t<this.nGroups;t++)this.tileGroups[t].isPlayed=!1}tryPlayWith(t,e){if(!t.isPlayed&&d(t)){for(let i of e)if(!i.isPlayed&&d(i))return[!0,this.play(t,i)]}return[!1,0]}handleFreeGroup(t,e){let i=0,s=0,[r,n,a,l]=e;if(r.isPlayed||n.isPlayed||a.isPlayed){for(let p of e)i+=this.checkFree(p);return e.every(p=>p.isPlayed)&&(t.isPlayed=!0,s+=2),[i,s]}let[u,c]=this.tryPlayWith(r,[n,a,l]);if(s+=c,u)return[i,s];if([u,c]=this.tryPlayWith(n,[a,l]),s+=c,u)return[i,s];let[h,m]=this.tryPlayWith(a,[l]);return s+=m,[i,s]}processGroup(t){if(t.isPlayed)return[0,0];let e=t.member,[i,s,r,n]=e,a=0,l=0;switch(t.pairing){case 0:{let[u,c]=this.handleFreeGroup(t,e);a+=u,l+=c;break}case 1:{l+=this.handlePairedGroup(i,s,r,t),l+=this.handlePairedGroup(r,n,i,t);break}case 2:{l+=this.handlePairedGroup(i,r,s,t),l+=this.handlePairedGroup(s,n,i,t);break}case 3:{l+=this.handlePairedGroup(i,n,s,t),l+=this.handlePairedGroup(s,r,i,t);break}case 4:{d(i)&&d(s)&&(l+=this.play(i,s),t.isPlayed=!0);break}case 5:{e.every(u=>d(u))&&(l+=this.play(i,s),l+=this.play(r,n),t.isPlayed=!0);break}}return[a,l]}prune(){let t=this.nTilesCount,e;do{e=t;for(let i=0;i<this.nGroups;i++){let[s,r]=this.processGroup(this.tileGroups[i]);e+=s,t-=r}}while(t!==e);return this.resetState(),t}};var k=class{constructor(t,e,i,s,r,n){this.nTilesCount=t,this.nGroups=e,this.tileList=i,this.tileGroups=s,this.remainMin=r,this.remainMax=n,this.nrPlays=0}randomSolve(t){let e=[],i=[0,0,1,3,6],s=[[0,1,2,3],[1,0,3,2],[2,3,0,1],[3,2,1,0]],r=()=>{for(let h=0;h<this.nGroups;h++){e[h]=0;let m=this.tileGroups[h];for(let p=0;p<m.nMembers;p++)d(m.member[p])&&e[h]++;m.pairing=-1,m.isPlayed=m.nMembers===2}},n=()=>{let h=0;for(let f=0;f<this.nGroups;f++){if((this.tileGroups[f].isPlayed?1:0)+i[e[f]]>=5)return{groupIndex:f,matchIndex:0};h+=i[e[f]]}if(h===0)return null;let m=G()%h,p=0;for(;m>=0&&(m-=i[e[p]],!(m<0));)p++;return{groupIndex:p,matchIndex:m+i[e[p]]}},a=(h,m)=>{let p=0,f=h.nMembers-1,y=(b,Q)=>{let q=b;for(;;){let C=h.member[q];if(!C.isPlayed&&d(C))break;q+=Q}return q};return m<=1&&(p=y(p,1),m===0&&(f=y(p+1,1))),m>=1&&(f=y(f,-1),m===2&&(p=y(f-1,-1))),[p,f]},l=(h,m,p)=>{let[f,y]=m,b=p;return b=this.playTile(h.member[f],e,b),b=this.playTile(h.member[y],e,b),h.isPlayed=!0,h.pairing=s[f][y],e[this.tileGroups.indexOf(h)]-=2,b},u=()=>{for(let h=0;h<this.nTilesCount;h++)this.tileList[h].isPlayed=!1;for(let h=0;h<this.nGroups;h++)this.tileGroups[h].isPlayed=!1,this.tileGroups[h].nMembers===2&&(this.tileGroups[h].pairing=4)},c=h=>{if(h>this.remainMax)return!1;for(let m=0;m<this.nGroups;m++)this.tileGroups[m].bestPairing=this.tileGroups[m].pairing;if(this.remainMax=h-2,this.remainMax<this.remainMin){for(let m=0;m<this.nGroups;m++)this.tileGroups[m].nMembers===4&&(this.tileGroups[m].pairing=0);return!0}return!1};for(let h=0;h<t;h++){let m=this.nTilesCount;for(r();;){let p=n();if(!p)break;let f=this.tileGroups[p.groupIndex],y=a(f,p.matchIndex);m=l(f,y,m)}if(u(),this.nrPlays++,c(m))return{success:!0,nrPlays:this.nrPlays,remainMax:this.remainMax}}for(let h=0;h<this.nGroups;h++)this.tileGroups[h].nMembers===4&&(this.tileGroups[h].pairing=0);return{success:!1,nrPlays:this.nrPlays,remainMax:this.remainMax}}playTile(t,e,i){let s=(n,a)=>{for(let l=0;n[l]!==void 0;l++){let u=n[l];u&&!u.isPlayed&&(e[u.value]+=d(u)?a:0)}};s(t.left,-1),s(t.right,-1),t.isPlayed=!0;let r=i-1;return s(t.left,1),s(t.right,1),s(t.below,1),r}};var P=class{constructor(){this.tileList=[],this.tileGroups=[],this.lo=[],this.qts=[],this.maxGroups=80,this.maxHeight=40,this.maxWidth=100,this.maxDepth=10}solveLayout(t){for(let e=0;e<this.maxHeight;e++){this.lo[e]=[];for(let i=0;i<this.maxWidth;i++){this.lo[e][i]=[];for(let s=0;s<this.maxDepth;s++)this.lo[e][i][s]=void 0}}for(let e of t){let i={left:[void 0,void 0,void 0],right:[void 0,void 0,void 0],above:[void 0,void 0,void 0,void 0,void 0],below:[void 0,void 0,void 0,void 0,void 0],value:e.groupNr,isPlayed:!1};this.lo[e.y][e.x][e.z]=i,this.tileList.push(i)}return this.nTilesCount=t.length,this.solve(0,0)}writeGame(){return this.unrotateGroups(),new w(this.nTilesCount,this.tileGroups,this.lo,this.nGroups,this.maxHeight,this.maxWidth,this.maxDepth).write()}unrotateGroups(){for(let t=0;t<this.nGroups;t++){switch(this.tileGroups[t].rotation){case 1:{let e=this.tileGroups[t].member[1];this.tileGroups[t].member[1]=this.tileGroups[t].member[2],this.tileGroups[t].member[2]=this.tileGroups[t].member[3],this.tileGroups[t].member[3]=e;break}case 2:{let e=this.tileGroups[t].member[3];this.tileGroups[t].member[3]=this.tileGroups[t].member[2],this.tileGroups[t].member[2]=this.tileGroups[t].member[1],this.tileGroups[t].member[1]=e;break}default:break}this.tileGroups[t].rotation=0}}sureSolve_checkInitialPrune(){return this.prune()>this.remainMax}sureSolve_findPrunePoint(t){for(let e=t;e<this.nGroups;e++)if(this.qts[e].pairing=1,this.prune()>this.remainMax)return e;return this.nGroups}sureSolve_handleSolutionFound(t){for(let e=0;e<this.nGroups;e++)this.tileGroups[e].bestPairing=this.tileGroups[e].pairing;for(let e=this.qtsIndex;e<this.nGroups;e++)this.qts[e].bestPairing+=3-this.qts[e].rotation,this.qts[e].bestPairing>3&&(this.qts[e].bestPairing-=3);if(this.remainMax=this.prune()-2,this.remainMax<this.remainMin){for(let e=this.qtsIndex;e<this.nGroups;e++)this.qts[e].pairing=0;return!0}for(let e=t;e<this.nGroups;e++)this.qts[e].pairing=0;return this.sureSolve(t)}sureSolve_rotateTiles(t,e){let i=this.qts[t];if(e){let s=i.member[3];i.member[3]=i.member[2],i.member[2]=i.member[1],i.member[1]=s,i.rotation=(i.rotation+1)%3}else{let s=i.member[1];i.member[1]=i.member[2],i.member[2]=i.member[3],i.member[3]=s,i.rotation=(i.rotation+2)%3}}sureSolve_identifyRequiredNodes(t,e){let i=[this.qts[t]],s=1,r=t;for(let n=t-1;n>=e;n--)this.qts[n].pairing=0,this.prune()<=this.remainMax?(this.qts[n].pairing=1,i[s++]=this.qts[n]):(this.sureSolve_rotateTiles(n,G()%2===0),this.qts[r]=this.qts[n],r--);for(let n=r;n>=e;n--)this.qts[n]=i[--s];return r}sureSolve_tryAdvancedPairings(t,e){for(let i=t;i>=e;i--){if(this.qts[i].pairing=2,this.sureSolve(i+1)||(this.qts[i].pairing=3,this.sureSolve(i+1)))return!0;this.qts[i].pairing=0}return!1}sureSolve(t){if(this.sureSolve_checkInitialPrune())return!1;let e=this.sureSolve_findPrunePoint(t);if(e===this.nGroups)return this.sureSolve_handleSolutionFound(t);let i=this.sureSolve_identifyRequiredNodes(e,t);return this.sureSolve_tryAdvancedPairings(i,t)}init(){let t=new M(this.tileList,this.lo,this.qts,this.maxHeight,this.maxWidth,this.maxDepth,this.maxGroups,this.nTilesCount).initSolve();this.tileGroups=t.tileGroups,this.qtsIndex=t.qtsIndex,this.nGroups=t.nGroups}prune(){return this.nPlays++,new S(this.nTilesCount,this.nGroups,this.tileList,this.tileGroups).prune()}randomSolve(t){let e=new k(this.nTilesCount,this.nGroups,this.tileList,this.tileGroups,this.remainMin,this.remainMax).randomSolve(t);return this.remainMax=e.remainMax,this.nrPlays+=e.nrPlays,e.success}solve(t,e){if(this.init(),this.nrPlays=0,this.nPlays=0,this.remainMax=Math.max(t,e),this.remainMin=Math.min(t,e),this.prune()>this.remainMax)return this.remainMax+2;let i=Math.floor(1.2**(this.nGroups-this.qtsIndex));return this.randomSolve(i)?this.remainMax+2:(this.sureSolve(this.qtsIndex),this.unrotateGroups(),this.remainMax+2)}};function V(o,t){let e=new P,i=e.solveLayout(o);t({result:i,order:e.writeGame()})}function K(o,t,e,i){let s=new P,r=new E(new $(o.length)),n=0,a=0;for(let l=0;l<t;l++){let u=r.build(O,o);u&&(s.solveLayout(u)>0?n++:a++,e([a,n]))}i([a,n])}function U(){return new Worker(new URL("worker-RVTPFB3A.js",import.meta.url),{type:"module"})}function B(){return new Worker(new URL("worker-XPYL3QRD.js",import.meta.url),{type:"module"})}var jt=(()=>{let t=class t{solveGame(i,s){if(typeof Worker<"u"){let r=B();return r&&(T(r,"message").pipe(x(l=>l.data),L()).pipe(x(l=>l.result),v(l=>!!l),N(1)).subscribe(l=>{s(l),r.terminate()}),r.postMessage({stones:i})),r}V(i,s)}solve(i,s,r,n){if(typeof Worker<"u"){let a=U();if(a){let l=T(a,"message").pipe(x(c=>c.data),L()),u=l.pipe(x(c=>c.result),v(c=>Array.isArray(c)),N(1));l.pipe(x(c=>c.progress),v(c=>Array.isArray(c)),W(u)).subscribe(c=>{r(c)}),u.subscribe(c=>{n(c),a.terminate()}),a.postMessage({mapping:i,rounds:s})}return a}K(i,s,r,n)}};t.\u0275fac=function(s){return new(s||t)},t.\u0275prov=I({token:t,factory:t.\u0275fac,providedIn:"root"});let o=t;return o})();var Ft=(()=>{let t=class t{constructor(){this.layout=_(),this.svg=F(),this.alt=_()}ngOnChanges(i){i.layout&&this.updateLayout(i.layout.currentValue)}updateLayout(i){this.svg.set(i?.previewSVG)}};t.\u0275fac=function(s){return new(s||t)},t.\u0275cmp=z({type:t,selectors:[["app-layout-preview"]],inputs:{layout:[1,"layout"],svg:[1,"svg"],alt:[1,"alt"]},outputs:{svg:"svgChange"},features:[j],decls:1,vars:2,consts:[[3,"src","alt"]],template:function(s,r){s&1&&H(0,"img",0),s&2&&A("src",r.svg(),D)("alt",r.alt())},styles:["[_nghost-%COMP%]{width:100%;height:100%;display:block}[_nghost-%COMP%]   img[_ngcontent-%COMP%]{height:100%;width:100%;object-fit:contain}"],changeDetection:0});let o=t;return o})();function tt(o){return o.sort((t,e)=>t[0]<e[0]?-1:t[0]>e[0]?1:t[1]<e[1]?-1:t[1]>e[1]?1:t[2]<e[2]?-1:t[2]>e[2]?1:0)}function et(o,t,e,i,s){return g(this,null,function*(){let r=t*e,n=r*o;if(s.length!==n)return Promise.reject(new Error("Invalid Matrix Pattern length"));let a={name:i,cat:"Kyodai",mapping:[]};for(let l=0;l<o;l++){let u=s.slice(l*r,(l+1)*r);for(let c=0;c<t;c++){let m=[...u.slice(c*e,(c+1)*e)];for(let[p,f]of m.entries())f==="1"&&a.mapping.push([l,p,c])}}return a})}function it(o,t){return g(this,null,function*(){return et(5,20,34,o,t)})}function J(o,t){return g(this,null,function*(){let e=[];for(let[i,s]of o.entries()){let r=Math.floor(i/t),n=i%t;for(let[a,l]of[...s].entries())l==="1"&&e.push([r,a,n])}return e})}function st(o,t){return g(this,null,function*(){let e=o.replace(/\r\n/g,`
`).split(`
`),i=t.split(".");i.pop();let s=e.shift()??"",r={name:i.join(".").replace(/_/g," "),cat:"uncategorized",mapping:[]};if(["kmahjongg-layout-v1.0"].includes(s))return r.by="KDE Games team",r.mapping=yield J(e.filter(n=>!n.startsWith("#")),16),r;if(["kmahjongg-layout-v1.1"].includes(s)){let n=Number((e.find(u=>u.startsWith("h"))??"h16").split("").slice().join("")),a=(e.find(u=>u.startsWith("# name:"))??"").slice(7).trim();r.name=a??r.name,r.name=r.name.length===0?t.split(".")[0]:r.name;let l=(e.find(u=>u.startsWith("# by:"))??"").slice(5).trim();return r.by=l||r.by,e=e.filter(u=>!u.startsWith("h")&&!u.startsWith("w")&&!u.startsWith("d")&&!u.startsWith("#")),r.mapping=yield J(e,Number.isNaN(n)?16:n),r}return Promise.reject(new Error(`Unknown .layout format ${JSON.stringify((s??"").slice(0,50))}`))})}function rt(o,t){return g(this,null,function*(){let e=o.replace(/\r\n/g,`
`).split(`
`),i=e[0]||"";if(["Kyodai 3.0","Kyodai 6.0"].includes(i)){let s=(e[1]||"").split("::"),r=s[0].length===0?t.split(".")[0]:s[0],n=s[1]||"uncategorized",a=e[2]||"",l=yield it(r,a);return l.cat=n||l.cat,l}return Promise.reject(new Error(`Unknown .lay format ${JSON.stringify((i||"").slice(0,50))}`))})}function nt(o){let t={},e=tt(o);for(let i of e)t[i[0]]=t[i[0]]||{},t[i[0]][i[2]]=t[i[0]][i[2]]||[],t[i[0]][i[2]].push(i[1]);return t}function ot(o,t,e){let i=e[o][t],s=[],r={start:-1,current:-1,count:0};for(let a of i)a===r.current?(r.current+=2,r.count++):(r={start:a,current:a+2,count:1},s.push(r));let n=s.map(a=>a.count===1?a.start:[a.start,a.count]);return[Number(t),n.length===1&&!Array.isArray(n[0])?n[0]:n]}function at(o){let t=nt(o),e=[];for(let i of Object.keys(t)){let s=[];for(let r of Object.keys(t[Number(i)]))s.push(ot(Number(i),Number(r),t));e.push([Number(i),s])}return e}function Y(o){return o.trim().split(" ").map(t=>t[0].toUpperCase()+t.slice(1)).join(" ").replace(/"/g,"").replace(/(^'|'$)/gm,"")}function X(o){let t=o.name.split(" by ");t.length>1&&(o.name=t[0].trim(),o.by=t[1].trim()),o.name=Y(o.name||""),o.by=o.by?Y(o.by):void 0;let e=lt(o.mapping);return{id:R(e),name:o.name.trim(),cat:o.cat.trim(),by:o.by,map:at(e)}}function lt(o){if(o.length===0)return[];let t=o[0][0],e=o[0][1],i=o[0][2];for(let s of o)t=Math.min(s[0],t),e=Math.min(s[1],e),i=Math.min(s[2],i);return o.map(s=>[s[0]-(t||0),s[1]-(e||0),s[2]-(i||0)])}function ht(o){return g(this,null,function*(){let t=new FileReader;return new Promise((e,i)=>{t.addEventListener("load",()=>{e(t.result)}),t.addEventListener("error",s=>{i(new Error(`Reading File failed: ${s?.target?.error?.message??"unknown error"}`))}),t.readAsText(o,"ascii")})})}function $t(o){return g(this,null,function*(){let t=yield ht(o),e=(o.name.split(".").pop()??"").toLowerCase(),i;if(e==="lay")i=X(yield rt(t,o.name));else if(e==="layout")i=X(yield st(t,o.name));else return JSON.parse(t).boards;return[i]})}export{jt as a,Ft as b,at as c,lt as d,$t as e};
