function S(){return Math.floor(Math.random()*100)}function c(l){if(!l)return!1;let e=0,t=l.above[e];for(;t!==void 0;){if(!t.isPlayed)return!1;e++,t=l.above[e]}e=0;let r=l.left[e];for(;r!==void 0;){if(!r.isPlayed){e=0;let i=l.right[e];for(;i!==void 0;){if(!i.isPlayed)return!1;e++,i=l.right[e]}return!0}e++,r=l.left[e]}return!0}var x=class{constructor(e,t,r,i,s,n,o,a){this.tileList=e;this.lo=t;this.qts=r;this.maxHeight=i;this.maxWidth=s;this.maxDepth=n;this.maxGroups=o;this.nTilesCount=a;this.tileGroups=[]}initSolve(){return this.initSolve_clearTileNeighbors(),this.initSolve_computeHorizontalNeighbors(),this.initSolve_computeVerticalNeighbors(),this.initSolve_initializeGroups(),this.initSolve_setupSearchSystem(),{tileGroups:this.tileGroups,qtsIndex:this.qtsIndex,nGroups:this.nGroups}}initSolve_clearTileNeighbors(){for(let e of this.tileList){for(let t of["left","right","above","below"]){let r=t==="above"||t==="below"?5:3;for(let i=0;i<r;i++)e[t][i]=void 0}e.isPlayed=!1}}initSolve_forEachAdjacentPosition(e,t,r){for(let i=Math.max(e-1,0);i<Math.min(e+2,this.maxHeight);i++)for(let s=Math.max(t-1,0);s<Math.min(t+2,this.maxWidth);s++)r(i,s)}initSolve_linkHorizontalNeighbors(e,t,r){let i=this.lo[e][t][r],s=this.lo[e][t-2][r];if(i){let n=0;for(let o=Math.max(e-1,0);o<Math.min(e+2,this.maxHeight);o++)this.lo[o][t-2][r]&&(i.left[n++]=this.lo[o][t-2][r])}if(s){let n=0;for(let o=Math.max(e-1,0);o<Math.min(e+2,this.maxHeight);o++)this.lo[o][t][r]&&(s.right[n++]=this.lo[o][t][r])}}initSolve_computeHorizontalNeighbors(){for(let e=0;e<this.maxHeight;e++)for(let t=2;t<this.maxWidth;t++)for(let r=0;r<this.maxDepth;r++)this.initSolve_linkHorizontalNeighbors(e,t,r)}initSolve_linkVerticalNeighbors(e,t,r){let i=this.lo[e][t][r-1],s=this.lo[e][t][r];if(i){let n=0;this.initSolve_forEachAdjacentPosition(e,t,(o,a)=>{this.lo[o][a][r]&&(i.above[n++]=this.lo[o][a][r])})}if(s){let n=0;this.initSolve_forEachAdjacentPosition(e,t,(o,a)=>{this.lo[o][a][r-1]&&(s.below[n++]=this.lo[o][a][r-1])})}}initSolve_computeVerticalNeighbors(){for(let e=0;e<this.maxHeight;e++)for(let t=0;t<this.maxWidth;t++)for(let r=1;r<this.maxDepth;r++)this.initSolve_linkVerticalNeighbors(e,t,r)}initSolve_initializeGroups(){this.tileGroups=[];for(let e=0;e<this.maxGroups;e++)this.tileGroups.push({pairing:-1,bestPairing:-1,nMembers:0,member:[void 0,void 0,void 0,void 0],isPlayed:!1,rotation:0});for(let e=0;e<this.nTilesCount;e++){let t=this.tileList[e].value;this.tileGroups[t].member[this.tileGroups[t].nMembers]=this.tileList[e],this.tileGroups[t].nMembers++}}initSolve_setupSearchSystem(){let e=0,t=0;for(let r=0;r<this.maxGroups;r++){let i=this.tileGroups[r];i.nMembers===2&&(this.qts[e]=i,this.qts[e].pairing=4,e++),i.nMembers!==0&&(t=r)}for(let r=0;r<=t;r++){let i=this.tileGroups[r];i.nMembers===0&&(this.qts[e]=i,this.qts[e].pairing=-1,e++)}this.qtsIndex=e;for(let r=0;r<=t;r++){let i=this.tileGroups[r];if(i.nMembers===4){this.qts[e]=i,this.qts[e].pairing=0;let s=this.qtsIndex+S()%(e+1-this.qtsIndex),n=this.qts[e];this.qts[e]=this.qts[s],this.qts[s]=n,e++}}this.nGroups=e}};var A=class{constructor(e,t,r,i,s,n,o){this.qt=t;this.lo=r;this.nGroups=i;this.maxHeight=s;this.maxWidth=n;this.maxDepth=o;this.result=[];this.nTiles1=e,this.nTiles2=e}write(){do{this.nTiles1=this.nTiles2;for(let e=0;e<this.nGroups;e++)this.writeGroup(e)}while(this.nTiles2!==this.nTiles1);return this.result}writePair(e,t,r){let i=this.qt[e].member[t],s=this.qt[e].member[r];for(let n=0;n<this.maxHeight;n++)for(let o=0;o<this.maxWidth;o++)for(let a=0;a<this.maxDepth;a++)(this.lo[n][o][a]===i||this.lo[n][o][a]===s)&&this.result.push([a,o,n])}writePairing(e,t,r,i){let s=t.member[r],n=t.member[i],o=s&&n,a=o&&!s.isPlayed,p=o&&c(s)&&c(n);return o&&a&&p?(this.writePair(e,r,i),s.isPlayed=!0,n.isPlayed=!0,this.nTiles2-=2,!0):!1}writeGroup(e){let t=this.qt[e];switch(t.bestPairing){case 1:{if(this.writePairing(e,t,0,1)){let r=t.member[2];t.isPlayed=r.isPlayed}this.writePairing(e,t,2,3);break}case 2:{this.writePairing(e,t,0,2),this.writePairing(e,t,1,3);break}case 3:{this.writePairing(e,t,0,3),this.writePairing(e,t,1,2);break}case 4:{this.writePairing(e,t,0,1);break}default:break}}};var v=class{constructor(e,t,r,i){this.nTilesCount=e;this.nGroups=t;this.tileList=r;this.tileGroups=i}play(e,t){return e.isPlayed=!0,t.isPlayed=!0,2}checkFree(e){return!e.isPlayed&&c(e)?(e.isPlayed=!0,1):0}handlePairedGroup(e,t,r,i){let s=0;return!e.isPlayed&&c(e)&&c(t)&&(s=this.play(e,t),i.isPlayed=r.isPlayed),s}resetState(){for(let e=0;e<this.nTilesCount;e++)this.tileList[e].isPlayed=!1;for(let e=0;e<this.nGroups;e++)this.tileGroups[e].isPlayed=!1}tryPlayWith(e,t){if(!e.isPlayed&&c(e)){for(let r of t)if(!r.isPlayed&&c(r))return[!0,this.play(e,r)]}return[!1,0]}handleFreeGroup(e,t){let r=0,i=0,[s,n,o,a]=t;if(s.isPlayed||n.isPlayed||o.isPlayed){for(let h of t)r+=this.checkFree(h);return t.every(h=>h.isPlayed)&&(e.isPlayed=!0,i+=2),[r,i]}let[p,b]=this.tryPlayWith(s,[n,o,a]);if(i+=b,p)return[r,i];if([p,b]=this.tryPlayWith(n,[o,a]),i+=b,p)return[r,i];let[u,m]=this.tryPlayWith(o,[a]);return i+=m,[r,i]}processGroup(e){if(e.isPlayed)return[0,0];let t=e.member,[r,i,s,n]=t,o=0,a=0;switch(e.pairing){case 0:{let[p,b]=this.handleFreeGroup(e,t);o+=p,a+=b;break}case 1:{a+=this.handlePairedGroup(r,i,s,e),a+=this.handlePairedGroup(s,n,r,e);break}case 2:{a+=this.handlePairedGroup(r,s,i,e),a+=this.handlePairedGroup(i,n,r,e);break}case 3:{a+=this.handlePairedGroup(r,n,i,e),a+=this.handlePairedGroup(i,s,r,e);break}case 4:{c(r)&&c(i)&&(a+=this.play(r,i),e.isPlayed=!0);break}case 5:{t.every(p=>c(p))&&(a+=this.play(r,i),a+=this.play(s,n),e.isPlayed=!0);break}}return[o,a]}prune(){let e=this.nTilesCount,t;do{t=e;for(let r=0;r<this.nGroups;r++){let[i,s]=this.processGroup(this.tileGroups[r]);t+=i,e-=s}}while(e!==t);return this.resetState(),e}};var E=class{constructor(e,t,r,i,s,n){this.nTilesCount=e;this.nGroups=t;this.tileList=r;this.tileGroups=i;this.remainMin=s;this.remainMax=n;this.nrPlays=0}randomSolve(e){let t=[],r=[0,0,1,3,6],i=[[0,1,2,3],[1,0,3,2],[2,3,0,1],[3,2,1,0]],s=()=>{for(let u=0;u<this.nGroups;u++){t[u]=0;let m=this.tileGroups[u];for(let h=0;h<m.nMembers;h++)c(m.member[h])&&t[u]++;m.pairing=-1,m.isPlayed=m.nMembers===2}},n=()=>{let u=0;for(let _=0;_<this.nGroups;_++){if((this.tileGroups[_].isPlayed?1:0)+r[t[_]]>=5)return{groupIndex:_,matchIndex:0};u+=r[t[_]]}if(u===0)return null;let m=S()%u,h=0;for(;m>=0&&(m-=r[t[h]],!(m<0));)h++;return{groupIndex:h,matchIndex:m+r[t[h]]}},o=(u,m)=>{let h=0,_=u.nMembers-1,f=(g,B)=>{let D=g;for(;;){let k=u.member[D];if(!k.isPlayed&&c(k))break;D+=B}return D};return m<=1&&(h=f(h,1),m===0&&(_=f(h+1,1))),m>=1&&(_=f(_,-1),m===2&&(h=f(_-1,-1))),[h,_]},a=(u,m,h)=>{let[_,f]=m,g=h;return g=this.playTile(u.member[_],t,g),g=this.playTile(u.member[f],t,g),u.isPlayed=!0,u.pairing=i[_][f],t[this.tileGroups.indexOf(u)]-=2,g},p=()=>{for(let u=0;u<this.nTilesCount;u++)this.tileList[u].isPlayed=!1;for(let u=0;u<this.nGroups;u++)this.tileGroups[u].isPlayed=!1,this.tileGroups[u].nMembers===2&&(this.tileGroups[u].pairing=4)},b=u=>{if(u>this.remainMax)return!1;for(let m=0;m<this.nGroups;m++)this.tileGroups[m].bestPairing=this.tileGroups[m].pairing;if(this.remainMax=u-2,this.remainMax<this.remainMin){for(let m=0;m<this.nGroups;m++)this.tileGroups[m].nMembers===4&&(this.tileGroups[m].pairing=0);return!0}return!1};for(let u=0;u<e;u++){let m=this.nTilesCount;for(s();;){let h=n();if(!h)break;let _=this.tileGroups[h.groupIndex],f=o(_,h.matchIndex);m=a(_,f,m)}if(p(),this.nrPlays++,b(m))return{success:!0,nrPlays:this.nrPlays,remainMax:this.remainMax}}for(let u=0;u<this.nGroups;u++)this.tileGroups[u].nMembers===4&&(this.tileGroups[u].pairing=0);return{success:!1,nrPlays:this.nrPlays,remainMax:this.remainMax}}playTile(e,t,r){let i=(n,o)=>{for(let a=0;n[a]!==void 0;a++){let p=n[a];p&&!p.isPlayed&&(t[p.value]+=c(p)?o:0)}};i(e.left,-1),i(e.right,-1),e.isPlayed=!0;let s=r-1;return i(e.left,1),i(e.right,1),i(e.below,1),s}};var M=class{constructor(){this.tileList=[];this.tileGroups=[];this.lo=[];this.qts=[];this.maxGroups=80;this.maxHeight=40;this.maxWidth=100;this.maxDepth=10}solveLayout(e){for(let t=0;t<this.maxHeight;t++){this.lo[t]=[];for(let r=0;r<this.maxWidth;r++){this.lo[t][r]=[];for(let i=0;i<this.maxDepth;i++)this.lo[t][r][i]=void 0}}for(let t of e){let r={left:[void 0,void 0,void 0],right:[void 0,void 0,void 0],above:[void 0,void 0,void 0,void 0,void 0],below:[void 0,void 0,void 0,void 0,void 0],value:t.groupNr,isPlayed:!1};this.lo[t.y][t.x][t.z]=r,this.tileList.push(r)}return this.nTilesCount=e.length,this.solve(0,0)}writeGame(){return this.unrotateGroups(),new A(this.nTilesCount,this.tileGroups,this.lo,this.nGroups,this.maxHeight,this.maxWidth,this.maxDepth).write()}unrotateGroups(){for(let e=0;e<this.nGroups;e++){switch(this.tileGroups[e].rotation){case 1:{let t=this.tileGroups[e].member[1];this.tileGroups[e].member[1]=this.tileGroups[e].member[2],this.tileGroups[e].member[2]=this.tileGroups[e].member[3],this.tileGroups[e].member[3]=t;break}case 2:{let t=this.tileGroups[e].member[3];this.tileGroups[e].member[3]=this.tileGroups[e].member[2],this.tileGroups[e].member[2]=this.tileGroups[e].member[1],this.tileGroups[e].member[1]=t;break}default:break}this.tileGroups[e].rotation=0}}sureSolve_checkInitialPrune(){return this.prune()>this.remainMax}sureSolve_findPrunePoint(e){for(let t=e;t<this.nGroups;t++)if(this.qts[t].pairing=1,this.prune()>this.remainMax)return t;return this.nGroups}sureSolve_handleSolutionFound(e){for(let t=0;t<this.nGroups;t++)this.tileGroups[t].bestPairing=this.tileGroups[t].pairing;for(let t=this.qtsIndex;t<this.nGroups;t++)this.qts[t].bestPairing+=3-this.qts[t].rotation,this.qts[t].bestPairing>3&&(this.qts[t].bestPairing-=3);if(this.remainMax=this.prune()-2,this.remainMax<this.remainMin){for(let t=this.qtsIndex;t<this.nGroups;t++)this.qts[t].pairing=0;return!0}for(let t=e;t<this.nGroups;t++)this.qts[t].pairing=0;return this.sureSolve(e)}sureSolve_rotateTiles(e,t){let r=this.qts[e];if(t){let i=r.member[3];r.member[3]=r.member[2],r.member[2]=r.member[1],r.member[1]=i,r.rotation=(r.rotation+1)%3}else{let i=r.member[1];r.member[1]=r.member[2],r.member[2]=r.member[3],r.member[3]=i,r.rotation=(r.rotation+2)%3}}sureSolve_identifyRequiredNodes(e,t){let r=[this.qts[e]],i=1,s=e;for(let n=e-1;n>=t;n--)this.qts[n].pairing=0,this.prune()<=this.remainMax?(this.qts[n].pairing=1,r[i++]=this.qts[n]):(this.sureSolve_rotateTiles(n,S()%2===0),this.qts[s]=this.qts[n],s--);for(let n=s;n>=t;n--)this.qts[n]=r[--i];return s}sureSolve_tryAdvancedPairings(e,t){for(let r=e;r>=t;r--){if(this.qts[r].pairing=2,this.sureSolve(r+1)||(this.qts[r].pairing=3,this.sureSolve(r+1)))return!0;this.qts[r].pairing=0}return!1}sureSolve(e){if(this.sureSolve_checkInitialPrune())return!1;let t=this.sureSolve_findPrunePoint(e);if(t===this.nGroups)return this.sureSolve_handleSolutionFound(e);let r=this.sureSolve_identifyRequiredNodes(t,e);return this.sureSolve_tryAdvancedPairings(r,e)}init(){let e=new x(this.tileList,this.lo,this.qts,this.maxHeight,this.maxWidth,this.maxDepth,this.maxGroups,this.nTilesCount).initSolve();this.tileGroups=e.tileGroups,this.qtsIndex=e.qtsIndex,this.nGroups=e.nGroups}prune(){return this.nPlays++,new v(this.nTilesCount,this.nGroups,this.tileList,this.tileGroups).prune()}randomSolve(e){let t=new E(this.nTilesCount,this.nGroups,this.tileList,this.tileGroups,this.remainMin,this.remainMax).randomSolve(e);return this.remainMax=t.remainMax,this.nrPlays+=t.nrPlays,t.success}solve(e,t){if(this.init(),this.nrPlays=0,this.nPlays=0,this.remainMax=Math.max(e,t),this.remainMin=Math.min(e,t),this.prune()>this.remainMax)return this.remainMax+2;let r=Math.floor(1.2**(this.nGroups-this.qtsIndex));return this.randomSolve(r)?this.remainMax+2:(this.sureSolve(this.qtsIndex),this.unrotateGroups(),this.remainMax+2)}};var y=class l{constructor(e,t,r,i,s){this.picked=!1;this.group=[];this.z=e,this.x=t,this.y=r,this.v=i,this.groupNr=s}toPosition(){return{z:this.z,x:this.x,y:this.y,v:this.v,groupNr:this.groupNr}}isBlocked(){return l.hasStone(this.nodes.top)||l.hasStone(this.nodes.left)&&l.hasStone(this.nodes.right)}static hasStone(e){return e.some(t=>!t.picked)}},G=(l,e,t,r)=>{for(let i of l)if(i.z===e&&i.x===t&&i.y===r)return i};var d=class l{static random(e){return Math.floor(Math.random()*e.length)}static randomExtract(e){let t=l.random(e);return e.splice(t,1)[0]}static collectNodes(e,t){let r={left:[],right:[],top:[],bottom:[]},i;for(let s=t.y-1;s<=t.y+1;s++){i=G(e,t.z,t.x-2,s),i&&r.left.push(i),i=G(e,t.z,t.x+2,s),i&&r.right.push(i);for(let n=t.x-1;n<=t.x+1;n++)i=G(e,t.z+1,n,s),i&&r.top.push(i),i=G(e,t.z-1,n,s),i&&r.bottom.push(i)}return r}static fillStones(e,t){let r={};for(let i of e){let s=t.list[i.v];i.img=s?s.img:{id:void 0},r[i.groupNr]=r[i.groupNr]||[],r[i.groupNr].push(i),i.nodes=l.collectNodes(e,i)}for(let i of Object.keys(r)){let s=r[Number(i)];for(let n of s)n.group=s.filter(o=>o!==n)}return e}getTilesInGame(e,t){return e.list.filter(r=>r!==void 0)}getTilesInPairs(e,t){let r=[];for(let i of e.groups)for(let s=0;s<i.tiles.length;s+=2)r.push([i.tiles[s],i.tiles[s+1]]);return r}};var T=class extends d{build(e,t){let r=this.getTilesInGame(t,e.length),i=[],s=[...e];for(;s.length>0;){let n=d.randomExtract(r),o=d.randomExtract(s);i.push(new y(o[0],o[1],o[2],n.v,n.groupNr))}return d.fillStones(i,t),i}};var P=class extends d{build(e,t){let r=[];for(let n of e)r.push(new y(n[0],n[1],n[2],0,0));d.fillStones(r,t);let i=1,s=this.solve(r,t);for(;s.length===0&&i<1e3;){for(let n of r)n.picked=!1,n.v=0,n.groupNr=0;s=this.solve(r,t),i++}if(s.length===0)return new T().build(e,t);for(let n of r)n.picked=!1;return d.fillStones(r,t),r.sort((n,o)=>n.v-o.v),r}solve(e,t){let r=[],i=[],s=e.length/2,n=[...t.groups];for(;n.length>0;){let a=[...d.randomExtract(n).tiles],p=d.randomExtract(a),b=d.randomExtract(a),u=d.randomExtract(a),m=a[0];i.length<s&&i.push([p,b]),i.length<s&&i.push([u,m])}for(;i.length>0;){let o=d.randomExtract(i),a=e.filter(u=>!u.picked&&!u.isBlocked());if(a.length<2)return[];let p=d.randomExtract(a),b=d.randomExtract(a);p.v=o[0].v,p.img=o[0].img,p.groupNr=o[0].groupNr,p.picked=!0,b.v=o[1].v,b.img=o[1].img,b.groupNr=o[1].groupNr,b.picked=!0,r.push(o)}return r}};var w=class{build(e,t){let r=[];for(let i of e){let s=t.list[i[3]];if(s){let n=new y(i[0],i[1],i[2],i[3],s.groupNr);r.push(n)}}return d.fillStones(r,t),r}};var L="MODE_SOLVABLE",C="MODE_RANDOM",H=[{id:L,builder:P},{id:C,builder:T}],N=class{constructor(e){this.tiles=e}load(e){return new w().build(e,this.tiles)}build(e,t){let r,i=H.find(s=>s.id===e);if(i&&(r=new i.builder),r)return r.build(t,this.tiles)}};var q=[["t_do1","t_do1","t_do1","t_do1"],["t_do2","t_do2","t_do2","t_do2"],["t_do3","t_do3","t_do3","t_do3"],["t_do4","t_do4","t_do4","t_do4"],["t_do5","t_do5","t_do5","t_do5"],["t_do6","t_do6","t_do6","t_do6"],["t_do7","t_do7","t_do7","t_do7"],["t_do8","t_do8","t_do8","t_do8"],["t_do9","t_do9","t_do9","t_do9"],["t_ch1","t_ch1","t_ch1","t_ch1"],["t_ch2","t_ch2","t_ch2","t_ch2"],["t_ch3","t_ch3","t_ch3","t_ch3"],["t_ch4","t_ch4","t_ch4","t_ch4"],["t_ch5","t_ch5","t_ch5","t_ch5"],["t_ch6","t_ch6","t_ch6","t_ch6"],["t_ch7","t_ch7","t_ch7","t_ch7"],["t_ch8","t_ch8","t_ch8","t_ch8"],["t_ch9","t_ch9","t_ch9","t_ch9"],["t_ba1","t_ba1","t_ba1","t_ba1"],["t_ba2","t_ba2","t_ba2","t_ba2"],["t_ba3","t_ba3","t_ba3","t_ba3"],["t_ba4","t_ba4","t_ba4","t_ba4"],["t_ba5","t_ba5","t_ba5","t_ba5"],["t_ba6","t_ba6","t_ba6","t_ba6"],["t_ba7","t_ba7","t_ba7","t_ba7"],["t_ba8","t_ba8","t_ba8","t_ba8"],["t_ba9","t_ba9","t_ba9","t_ba9"],["t_se_spring","t_se_summer","t_se_fall","t_se_winter"],["t_wi_north","t_wi_north","t_wi_north","t_wi_north"],["t_wi_south","t_wi_south","t_wi_south","t_wi_south"],["t_wi_east","t_wi_east","t_wi_east","t_wi_east"],["t_wi_west","t_wi_west","t_wi_west","t_wi_west"],["t_fl_bamboo","t_fl_chrysanthemum","t_fl_orchid","t_fl_plum"],["t_dr_green","t_dr_green","t_dr_green","t_dr_green"],["t_dr_white","t_dr_white","t_dr_white","t_dr_white"],["t_dr_red","t_dr_red","t_dr_red","t_dr_red"]],I=[];for(let l=1;l<19;l++)I.push([`t_g${l}`,`t_g${l}`,`t_g${l}`,`t_g${l}`]);for(let l=1;l<10;l++)I.push([`t_e${l}`,`t_e${l}`,`t_e${l}`,`t_e${l}`]);var O=class{constructor(e){this.list=[];this.groups=[];let t=0,r=q.map(s=>s.map(n=>({id:n}))),i=Math.ceil(e/4);if(i>r.length){let s=I.map(n=>n.map(o=>({id:o})));for(r=[...r,...s];r.length<i;)r.push([{id:`_${r.length}a`},{id:`_${r.length}b`},{id:`_${r.length}c`},{id:`_${r.length}d`}])}for(let[s,n]of r.entries()){let o={v:s,tiles:[]};this.groups.push(o);for(let a of n){t++;let p={groupNr:s,v:t,img:a};o.tiles.push(p),this.list[t]=p}}}};function R(l,e,t,r){let i=new M,s=new N(new O(l.length)),n=0,o=0;for(let a=0;a<e;a++){let p=s.build(L,l);p&&(i.solveLayout(p)>0?n++:o++,t([o,n]))}r([o,n])}addEventListener("message",({data:l})=>{l&&R(l.mapping,l.rounds,e=>{postMessage({progress:e})},e=>{postMessage({result:e})})});
