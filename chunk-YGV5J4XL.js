import{Db as C,Fb as N,Yb as H,h as y,l as w,n as g,q as T,s as _,v as L,z as I}from"./chunk-XEHCUY67.js";function x(){return Math.floor(Math.random()*100)}function d(p){if(!p)return!1;let t=0,e=p.above[t];for(;e!==void 0;){if(!e.isPlayed)return!1;t++,e=p.above[t]}t=0;let i=p.left[t];for(;i!==void 0;){if(!i.isPlayed){t=0;let s=p.right[t];for(;s!==void 0;){if(!s.isPlayed)return!1;t++,s=p.right[t]}return!0}t++,i=p.left[t]}return!0}var v=class{constructor(t,e,i,s,o,r,n,l){this.tileList=t,this.lo=e,this.qts=i,this.maxHeight=s,this.maxWidth=o,this.maxDepth=r,this.maxGroups=n,this.nTilesCount=l,this.tileGroups=[]}initSolve(){return this.initSolve_clearTileNeighbors(),this.initSolve_computeHorizontalNeighbors(),this.initSolve_computeVerticalNeighbors(),this.initSolve_initializeGroups(),this.initSolve_setupSearchSystem(),{tileGroups:this.tileGroups,qtsIndex:this.qtsIndex,nGroups:this.nGroups}}initSolve_clearTileNeighbors(){for(let t of this.tileList){for(let e of["left","right","above","below"]){let i=e==="above"||e==="below"?5:3;for(let s=0;s<i;s++)t[e][s]=void 0}t.isPlayed=!1}}initSolve_forEachAdjacentPosition(t,e,i){for(let s=Math.max(t-1,0);s<Math.min(t+2,this.maxHeight);s++)for(let o=Math.max(e-1,0);o<Math.min(e+2,this.maxWidth);o++)i(s,o)}initSolve_linkHorizontalNeighbors(t,e,i){let s=this.lo[t][e][i],o=this.lo[t][e-2][i];if(s){let r=0;for(let n=Math.max(t-1,0);n<Math.min(t+2,this.maxHeight);n++)this.lo[n][e-2][i]&&(s.left[r++]=this.lo[n][e-2][i])}if(o){let r=0;for(let n=Math.max(t-1,0);n<Math.min(t+2,this.maxHeight);n++)this.lo[n][e][i]&&(o.right[r++]=this.lo[n][e][i])}}initSolve_computeHorizontalNeighbors(){for(let t=0;t<this.maxHeight;t++)for(let e=2;e<this.maxWidth;e++)for(let i=0;i<this.maxDepth;i++)this.initSolve_linkHorizontalNeighbors(t,e,i)}initSolve_linkVerticalNeighbors(t,e,i){let s=this.lo[t][e][i-1],o=this.lo[t][e][i];if(s){let r=0;this.initSolve_forEachAdjacentPosition(t,e,(n,l)=>{this.lo[n][l][i]&&(s.above[r++]=this.lo[n][l][i])})}if(o){let r=0;this.initSolve_forEachAdjacentPosition(t,e,(n,l)=>{this.lo[n][l][i-1]&&(o.below[r++]=this.lo[n][l][i-1])})}}initSolve_computeVerticalNeighbors(){for(let t=0;t<this.maxHeight;t++)for(let e=0;e<this.maxWidth;e++)for(let i=1;i<this.maxDepth;i++)this.initSolve_linkVerticalNeighbors(t,e,i)}initSolve_initializeGroups(){this.tileGroups=[];for(let t=0;t<this.maxGroups;t++)this.tileGroups.push({pairing:-1,bestPairing:-1,nMembers:0,member:[void 0,void 0,void 0,void 0],isPlayed:!1,rotation:0});for(let t=0;t<this.nTilesCount;t++){let e=this.tileList[t].value;this.tileGroups[e].member[this.tileGroups[e].nMembers]=this.tileList[t],this.tileGroups[e].nMembers++}}initSolve_setupSearchSystem(){let t=0,e=0;for(let i=0;i<this.maxGroups;i++){let s=this.tileGroups[i];s.nMembers===2&&(this.qts[t]=s,this.qts[t].pairing=4,t++),s.nMembers!==0&&(e=i)}for(let i=0;i<=e;i++){let s=this.tileGroups[i];s.nMembers===0&&(this.qts[t]=s,this.qts[t].pairing=-1,t++)}this.qtsIndex=t;for(let i=0;i<=e;i++){let s=this.tileGroups[i];if(s.nMembers===4){this.qts[t]=s,this.qts[t].pairing=0;let o=this.qtsIndex+x()%(t+1-this.qtsIndex),r=this.qts[t];this.qts[t]=this.qts[o],this.qts[o]=r,t++}}this.nGroups=t}};var M=class{constructor(t,e,i,s,o,r,n){this.qt=e,this.lo=i,this.nGroups=s,this.maxHeight=o,this.maxWidth=r,this.maxDepth=n,this.result=[],this.nTiles1=t,this.nTiles2=t}write(){do{this.nTiles1=this.nTiles2;for(let t=0;t<this.nGroups;t++)this.writeGroup(t)}while(this.nTiles2!==this.nTiles1);return this.result}writePair(t,e,i){let s=this.qt[t].member[e],o=this.qt[t].member[i];for(let r=0;r<this.maxHeight;r++)for(let n=0;n<this.maxWidth;n++)for(let l=0;l<this.maxDepth;l++)(this.lo[r][n][l]===s||this.lo[r][n][l]===o)&&this.result.push([l,n,r])}writePairing(t,e,i,s){let o=e.member[i],r=e.member[s],n=o&&r,l=n&&!o.isPlayed,h=n&&d(o)&&d(r);return n&&l&&h?(this.writePair(t,i,s),o.isPlayed=!0,r.isPlayed=!0,this.nTiles2-=2,!0):!1}writeGroup(t){let e=this.qt[t];switch(e.bestPairing){case 1:{if(this.writePairing(t,e,0,1)){let i=e.member[2];e.isPlayed=i.isPlayed}this.writePairing(t,e,2,3);break}case 2:{this.writePairing(t,e,0,2),this.writePairing(t,e,1,3);break}case 3:{this.writePairing(t,e,0,3),this.writePairing(t,e,1,2);break}case 4:{this.writePairing(t,e,0,1);break}default:break}}};var S=class{constructor(t,e,i,s){this.nTilesCount=t,this.nGroups=e,this.tileList=i,this.tileGroups=s}play(t,e){return t.isPlayed=!0,e.isPlayed=!0,2}checkFree(t){return!t.isPlayed&&d(t)?(t.isPlayed=!0,1):0}handlePairedGroup(t,e,i,s){let o=0;return!t.isPlayed&&d(t)&&d(e)&&(o=this.play(t,e),s.isPlayed=i.isPlayed),o}resetState(){for(let t=0;t<this.nTilesCount;t++)this.tileList[t].isPlayed=!1;for(let t=0;t<this.nGroups;t++)this.tileGroups[t].isPlayed=!1}tryPlayWith(t,e){if(!t.isPlayed&&d(t)){for(let i of e)if(!i.isPlayed&&d(i))return[!0,this.play(t,i)]}return[!1,0]}handleFreeGroup(t,e){let i=0,s=0,[o,r,n,l]=e;if(o.isPlayed||r.isPlayed||n.isPlayed){for(let m of e)i+=this.checkFree(m);return e.every(m=>m.isPlayed)&&(t.isPlayed=!0,s+=2),[i,s]}let[h,b]=this.tryPlayWith(o,[r,n,l]);if(s+=b,h)return[i,s];if([h,b]=this.tryPlayWith(r,[n,l]),s+=b,h)return[i,s];let[a,u]=this.tryPlayWith(n,[l]);return s+=u,[i,s]}processGroup(t){if(t.isPlayed)return[0,0];let e=t.member,[i,s,o,r]=e,n=0,l=0;switch(t.pairing){case 0:{let[h,b]=this.handleFreeGroup(t,e);n+=h,l+=b;break}case 1:{l+=this.handlePairedGroup(i,s,o,t),l+=this.handlePairedGroup(o,r,i,t);break}case 2:{l+=this.handlePairedGroup(i,o,s,t),l+=this.handlePairedGroup(s,r,i,t);break}case 3:{l+=this.handlePairedGroup(i,r,s,t),l+=this.handlePairedGroup(s,o,i,t);break}case 4:{d(i)&&d(s)&&(l+=this.play(i,s),t.isPlayed=!0);break}case 5:{e.every(h=>d(h))&&(l+=this.play(i,s),l+=this.play(o,r),t.isPlayed=!0);break}}return[n,l]}prune(){let t=this.nTilesCount,e;do{e=t;for(let i=0;i<this.nGroups;i++){let[s,o]=this.processGroup(this.tileGroups[i]);e+=s,t-=o}}while(t!==e);return this.resetState(),t}};var k=class{constructor(t,e,i,s,o,r){this.nTilesCount=t,this.nGroups=e,this.tileList=i,this.tileGroups=s,this.remainMin=o,this.remainMax=r,this.nrPlays=0}randomSolve(t){let e=[],i=[0,0,1,3,6],s=[[0,1,2,3],[1,0,3,2],[2,3,0,1],[3,2,1,0]],o=()=>{for(let a=0;a<this.nGroups;a++){e[a]=0;let u=this.tileGroups[a];for(let m=0;m<u.nMembers;m++)d(u.member[m])&&e[a]++;u.pairing=-1,u.isPlayed=u.nMembers===2}},r=()=>{let a=0;for(let f=0;f<this.nGroups;f++){if((this.tileGroups[f].isPlayed?1:0)+i[e[f]]>=5)return{groupIndex:f,matchIndex:0};a+=i[e[f]]}if(a===0)return null;let u=x()%a,m=0;for(;u>=0&&(u-=i[e[m]],!(u<0));)m++;return{groupIndex:m,matchIndex:u+i[e[m]]}},n=(a,u)=>{let m=0,f=a.nMembers-1,c=(G,j)=>{let q=G;for(;;){let W=a.member[q];if(!W.isPlayed&&d(W))break;q+=j}return q};return u<=1&&(m=c(m,1),u===0&&(f=c(m+1,1))),u>=1&&(f=c(f,-1),u===2&&(m=c(f-1,-1))),[m,f]},l=(a,u,m)=>{let[f,c]=u,G=m;return G=this.playTile(a.member[f],e,G),G=this.playTile(a.member[c],e,G),a.isPlayed=!0,a.pairing=s[f][c],e[this.tileGroups.indexOf(a)]-=2,G},h=()=>{for(let a=0;a<this.nTilesCount;a++)this.tileList[a].isPlayed=!1;for(let a=0;a<this.nGroups;a++)this.tileGroups[a].isPlayed=!1,this.tileGroups[a].nMembers===2&&(this.tileGroups[a].pairing=4)},b=a=>{if(a>this.remainMax)return!1;for(let u=0;u<this.nGroups;u++)this.tileGroups[u].bestPairing=this.tileGroups[u].pairing;if(this.remainMax=a-2,this.remainMax<this.remainMin){for(let u=0;u<this.nGroups;u++)this.tileGroups[u].nMembers===4&&(this.tileGroups[u].pairing=0);return!0}return!1};for(let a=0;a<t;a++){let u=this.nTilesCount;for(o();;){let m=r();if(!m)break;let f=this.tileGroups[m.groupIndex],c=n(f,m.matchIndex);u=l(f,c,u)}if(h(),this.nrPlays++,b(u))return{success:!0,nrPlays:this.nrPlays,remainMax:this.remainMax}}for(let a=0;a<this.nGroups;a++)this.tileGroups[a].nMembers===4&&(this.tileGroups[a].pairing=0);return{success:!1,nrPlays:this.nrPlays,remainMax:this.remainMax}}playTile(t,e,i){let s=(r,n)=>{for(let l=0;r[l]!==void 0;l++){let h=r[l];h&&!h.isPlayed&&(e[h.value]+=d(h)?n:0)}};s(t.left,-1),s(t.right,-1),t.isPlayed=!0;let o=i-1;return s(t.left,1),s(t.right,1),s(t.below,1),o}};var P=class{constructor(){this.tileList=[],this.tileGroups=[],this.lo=[],this.qts=[],this.maxGroups=80,this.maxHeight=40,this.maxWidth=100,this.maxDepth=10}solveLayout(t){for(let e=0;e<this.maxHeight;e++){this.lo[e]=[];for(let i=0;i<this.maxWidth;i++){this.lo[e][i]=[];for(let s=0;s<this.maxDepth;s++)this.lo[e][i][s]=void 0}}for(let e of t){let i={left:[void 0,void 0,void 0],right:[void 0,void 0,void 0],above:[void 0,void 0,void 0,void 0,void 0],below:[void 0,void 0,void 0,void 0,void 0],value:e.groupNr,isPlayed:!1};this.lo[e.y][e.x][e.z]=i,this.tileList.push(i)}return this.nTilesCount=t.length,this.solve(0,0)}writeGame(){return this.unrotateGroups(),new M(this.nTilesCount,this.tileGroups,this.lo,this.nGroups,this.maxHeight,this.maxWidth,this.maxDepth).write()}unrotateGroups(){for(let t=0;t<this.nGroups;t++){switch(this.tileGroups[t].rotation){case 1:{let e=this.tileGroups[t].member[1];this.tileGroups[t].member[1]=this.tileGroups[t].member[2],this.tileGroups[t].member[2]=this.tileGroups[t].member[3],this.tileGroups[t].member[3]=e;break}case 2:{let e=this.tileGroups[t].member[3];this.tileGroups[t].member[3]=this.tileGroups[t].member[2],this.tileGroups[t].member[2]=this.tileGroups[t].member[1],this.tileGroups[t].member[1]=e;break}default:break}this.tileGroups[t].rotation=0}}sureSolve_checkInitialPrune(){return this.prune()>this.remainMax}sureSolve_findPrunePoint(t){for(let e=t;e<this.nGroups;e++)if(this.qts[e].pairing=1,this.prune()>this.remainMax)return e;return this.nGroups}sureSolve_handleSolutionFound(t){for(let e=0;e<this.nGroups;e++)this.tileGroups[e].bestPairing=this.tileGroups[e].pairing;for(let e=this.qtsIndex;e<this.nGroups;e++)this.qts[e].bestPairing+=3-this.qts[e].rotation,this.qts[e].bestPairing>3&&(this.qts[e].bestPairing-=3);if(this.remainMax=this.prune()-2,this.remainMax<this.remainMin){for(let e=this.qtsIndex;e<this.nGroups;e++)this.qts[e].pairing=0;return!0}for(let e=t;e<this.nGroups;e++)this.qts[e].pairing=0;return this.sureSolve(t)}sureSolve_rotateTiles(t,e){let i=this.qts[t];if(e){let s=i.member[3];i.member[3]=i.member[2],i.member[2]=i.member[1],i.member[1]=s,i.rotation=(i.rotation+1)%3}else{let s=i.member[1];i.member[1]=i.member[2],i.member[2]=i.member[3],i.member[3]=s,i.rotation=(i.rotation+2)%3}}sureSolve_identifyRequiredNodes(t,e){let i=[this.qts[t]],s=1,o=t;for(let r=t-1;r>=e;r--)this.qts[r].pairing=0,this.prune()<=this.remainMax?(this.qts[r].pairing=1,i[s++]=this.qts[r]):(this.sureSolve_rotateTiles(r,x()%2===0),this.qts[o]=this.qts[r],o--);for(let r=o;r>=e;r--)this.qts[r]=i[--s];return o}sureSolve_tryAdvancedPairings(t,e){for(let i=t;i>=e;i--){if(this.qts[i].pairing=2,this.sureSolve(i+1)||(this.qts[i].pairing=3,this.sureSolve(i+1)))return!0;this.qts[i].pairing=0}return!1}sureSolve(t){if(this.sureSolve_checkInitialPrune())return!1;let e=this.sureSolve_findPrunePoint(t);if(e===this.nGroups)return this.sureSolve_handleSolutionFound(t);let i=this.sureSolve_identifyRequiredNodes(e,t);return this.sureSolve_tryAdvancedPairings(i,t)}init(){let t=new v(this.tileList,this.lo,this.qts,this.maxHeight,this.maxWidth,this.maxDepth,this.maxGroups,this.nTilesCount).initSolve();this.tileGroups=t.tileGroups,this.qtsIndex=t.qtsIndex,this.nGroups=t.nGroups}prune(){return this.nPlays++,new S(this.nTilesCount,this.nGroups,this.tileList,this.tileGroups).prune()}randomSolve(t){let e=new k(this.nTilesCount,this.nGroups,this.tileList,this.tileGroups,this.remainMin,this.remainMax).randomSolve(t);return this.remainMax=e.remainMax,this.nrPlays+=e.nrPlays,e.success}solve(t,e){if(this.init(),this.nrPlays=0,this.nPlays=0,this.remainMax=Math.max(t,e),this.remainMin=Math.min(t,e),this.prune()>this.remainMax)return this.remainMax+2;let i=Math.floor(1.2**(this.nGroups-this.qtsIndex));return this.randomSolve(i)?this.remainMax+2:(this.sureSolve(this.qtsIndex),this.unrotateGroups(),this.remainMax+2)}};function A(p,t){let e=new P,i=e.solveLayout(p);t({result:i,order:e.writeGame()})}function D(p,t,e,i){let s=new P,o=new N(new H(p.length)),r=0,n=0;for(let l=0;l<t;l++){let h=o.build(C,p);h&&(s.solveLayout(h)>0?r++:n++,e([n,r]))}i([n,r])}function F(){return new Worker(new URL("worker-LASFWGHM.js",import.meta.url),{type:"module"})}function z(){return new Worker(new URL("worker-RBVTA4DO.js",import.meta.url),{type:"module"})}var ft=(()=>{class p{solveGame(e,i){if(typeof Worker<"u"){let s=z();return s&&(w(s,"message").pipe(y(n=>n.data),_()).pipe(y(n=>n.result),g(n=>!!n),T(1)).subscribe(n=>{i(n),s.terminate()}),s.postMessage({stones:e})),s}A(e,i)}solve(e,i,s,o){if(typeof Worker<"u"){let r=F();if(r){let n=w(r,"message").pipe(y(h=>h.data),_()),l=n.pipe(y(h=>h.result),g(h=>Array.isArray(h)),T(1));n.pipe(y(h=>h.progress),g(h=>Array.isArray(h)),L(l)).subscribe(h=>{s(h)}),l.subscribe(h=>{o(h),r.terminate()}),r.postMessage({mapping:e,rounds:i})}return r}D(e,i,s,o)}static{this.\u0275fac=function(i){return new(i||p)}}static{this.\u0275prov=I({token:p,factory:p.\u0275fac,providedIn:"root"})}}return p})();export{ft as a};
